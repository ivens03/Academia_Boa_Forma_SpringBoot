<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Alunos</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Adiciona as cores dinâmicas ao safelist do Tailwind para garantir que sejam geradas
        tailwind.config = {
            safelist: [
                'border-red-500', 'bg-red-100', 'text-red-800',
                'border-yellow-500', 'bg-yellow-100', 'text-yellow-800',
                'border-green-500', 'bg-green-100', 'text-green-800',
                'border-gray-500', 'bg-gray-100', 'text-gray-800',
                'text-red-600'
            ]
        }
    </script>

    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">

    <!-- Lucide Icons (via JS) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Evita a rolagem do corpo da página */
        }
        .sidebar {
            background-color: #262D68;
        }
        .sidebar-list {
            height: calc(100vh - 270px); /* Ajusta a altura da lista de alunos */
        }
        main {
            height: 100vh;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-slate-100">

<div class="flex flex-col md:flex-row">

    <!-- Coluna da Esquerda: Lista de Alunos -->
    <aside class="sidebar w-full md:w-1/3 lg:w-1/4 p-4 flex flex-col text-white">
        <h1 class="text-2xl font-bold mb-4">Gerenciar Alunos</h1>
        <div class="relative mb-4">
            <input id="search-input" type="search" placeholder="Buscar alunos..." class="w-full p-3 pl-12 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition bg-gray-700 text-white" autocomplete="off" />
            <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
        </div>

        <!-- Filtros Dropdown -->
        <div class="grid grid-cols-2 gap-2 mb-4">
            <!-- Filtro de Status de Pagamento -->
            <div class="relative">
                <button id="payment-status-filter-btn" class="flex items-center justify-between w-full px-3 py-2 text-sm text-left bg-gray-700 rounded-lg hover:bg-gray-600 transition-all">
                    <span id="payment-status-filter-text" class="flex-grow">Todos os Status</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 flex-shrink-0 ml-2 transition-transform duration-200"></i>
                </button>
                <div id="payment-status-filter-options" class="hidden absolute z-10 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg">
                    <a href="#" data-filter="all" class="flex items-center justify-between px-3 py-2 text-sm hover:bg-gray-600">
                        <span>Todos os Status</span>
                        <i data-lucide="check" class="w-4 h-4 text-green-400 hidden"></i>
                    </a>
                    <a href="#" data-filter="paid" class="flex items-center justify-between px-3 py-2 text-sm hover:bg-gray-600">
                        <span>Em dia</span>
                        <i data-lucide="check" class="w-4 h-4 text-green-400 hidden"></i>
                    </a>
                    <a href="#" data-filter="due" class="flex items-center justify-between px-3 py-2 text-sm hover:bg-gray-600">
                        <span>Próximo Venc.</span>
                        <i data-lucide="check" class="w-4 h-4 text-green-400 hidden"></i>
                    </a>
                    <a href="#" data-filter="overdue" class="flex items-center justify-between px-3 py-2 text-sm hover:bg-gray-600">
                        <span>Atrasado</span>
                        <i data-lucide="check" class="w-4 h-4 text-green-400 hidden"></i>
                    </a>
                </div>
            </div>
            <!-- Filtro de Status do Usuário -->
            <div class="relative">
                <button id="user-status-filter-btn" class="flex items-center justify-between w-full px-3 py-2 text-sm text-left bg-gray-700 rounded-lg hover:bg-gray-600 transition-all">
                    <span id="user-status-filter-text" class="flex-grow">Todos</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 flex-shrink-0 ml-2 transition-transform duration-200"></i>
                </button>
                <div id="user-status-filter-options" class="hidden absolute z-10 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg">
                    <a href="#" data-filter="active" class="flex items-center justify-between px-3 py-2 text-sm hover:bg-gray-600">
                        <span>Ativos</span>
                        <i data-lucide="check" class="w-4 h-4 text-green-400 hidden"></i>
                    </a>
                    <a href="#" data-filter="inactive" class="flex items-center justify-between px-3 py-2 text-sm hover:bg-gray-600">
                        <span>Inativos</span>
                        <i data-lucide="check" class="w-4 h-4 text-green-400 hidden"></i>
                    </a>
                    <a href="#" data-filter="all" class="flex items-center justify-between px-3 py-2 text-sm hover:bg-gray-600">
                        <span>Todos</span>
                        <i data-lucide="check" class="w-4 h-4 text-green-400" style="display: none;"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Botão Voltar -->
        <div class="mb-4">
            <a th:href="@{/homeGestor}" class="flex items-center justify-center w-full px-4 py-3 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors">
                <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                Voltar
            </a>
        </div>

        <div class="sidebar-list flex-grow overflow-y-auto pr-2">
            <ul id="student-list" class="space-y-2">
                <!-- A lista de alunos será inserida aqui via JS -->
            </ul>
        </div>

    </aside>

    <!-- Coluna da Direita: Detalhes do Aluno -->
    <main class="w-full md:w-2/3 lg:w-3/4 p-6 overflow-y-auto">
        <div id="student-details-container" class="hidden">
            <!-- Os detalhes do aluno serão inseridos aqui via JS -->
        </div>

        <div id="initial-view" class="flex flex-col items-center justify-center h-full text-center text-gray-500">
            <i data-lucide="users" class="w-16 h-16 mb-4 text-gray-400"></i>
            <h2 class="text-2xl font-bold">Selecione um aluno</h2>
            <p class="mt-2">Clique em um aluno na lista à esquerda para ver seus detalhes.</p>
        </div>
    </main>
</div>

<!-- Modal de Novo Pagamento -->
<div id="payment-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md m-4">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Registrar Novo Pagamento</h2>
        <form id="payment-form">
            <div class="space-y-4">
                <div>
                    <label for="valor" class="block text-sm font-medium text-gray-700">Valor Pago (R$)</label>
                    <input type="number" id="valor" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="150.00" />
                </div>
                <div>
                    <label for="formaPagamento" class="block text-sm font-medium text-gray-700">Forma de Pagamento</label>
                    <select id="formaPagamento" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option>Pix</option>
                        <option>Cartão de Crédito</option>
                        <option>Cartão de Débito</option>
                        <option>Dinheiro</option>
                        <option>Boleto</option>
                    </select>
                </div>
                <div>
                    <label for="vencimento" class="block text-sm font-medium text-gray-700">Próximo Vencimento</label>
                    <input type="date" id="vencimento" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" />
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="cancel-payment-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Confirmar Pagamento</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Confirmação -->
<div id="confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm m-4">
        <div class="flex flex-col items-center text-center">
            <div class="p-3 bg-red-100 rounded-full">
                <i data-lucide="alert-triangle" class="text-red-600 w-8 h-8"></i>
            </div>
            <h2 id="confirm-modal-title" class="text-xl font-bold text-gray-800 mt-4"></h2>
            <p id="confirm-modal-message" class="text-gray-600 mt-2"></p>
        </div>
        <div class="mt-6 flex justify-center gap-3">
            <button id="cancel-confirm-btn" class="px-4 py-2 w-full bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
            <button id="confirm-action-btn" class="px-4 py-2 w-full bg-red-600 text-white rounded-md hover:bg-red-700">Sim, continuar</button>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- DADOS ---
        let students = [];
        let selectedStudentId = null;
        let searchTerm = '';
        let paymentStatusFilter = 'all';
        let userStatusFilter = 'all';
        let searchTimeout = null;
        let isFetching = false;

        // --- ELEMENTOS DO DOM ---
        const studentListEl = document.getElementById('student-list');
        const searchInputEl = document.getElementById('search-input');
        const initialViewEl = document.getElementById('initial-view');
        const studentDetailsContainerEl = document.getElementById('student-details-container');
        const paymentModalEl = document.getElementById('payment-modal');
        const paymentFormEl = document.getElementById('payment-form');
        const cancelPaymentBtn = document.getElementById('cancel-payment-btn');
        const confirmModalEl = document.getElementById('confirm-modal');
        const backBtn = document.getElementById('back-btn');

        // Verificar elementos obrigatórios
        if (!studentListEl || !searchInputEl) {
            console.error('Elementos obrigatórios não encontrados no DOM');
            return;
        }

        // Elementos dos filtros dropdown (opcionais)
        const paymentStatusFilterBtn = document.getElementById('payment-status-filter-btn');
        const paymentStatusFilterText = document.getElementById('payment-status-filter-text');
        const paymentStatusFilterOptions = document.getElementById('payment-status-filter-options');
        const userStatusFilterBtn = document.getElementById('user-status-filter-btn');
        const userStatusFilterText = document.getElementById('user-status-filter-text');
        const userStatusFilterOptions = document.getElementById('user-status-filter-options');

        console.log('Elementos do DOM carregados:', {
            studentListEl: !!studentListEl,
            searchInputEl: !!searchInputEl,
            initialViewEl: !!initialViewEl,
            studentDetailsContainerEl: !!studentDetailsContainerEl,
            paymentModalEl: !!paymentModalEl,
            paymentFormEl: !!paymentFormEl,
            cancelPaymentBtn: !!cancelPaymentBtn,
            confirmModalEl: !!confirmModalEl,
            backBtn: !!backBtn,
            paymentStatusFilterBtn: !!paymentStatusFilterBtn,
            paymentStatusFilterText: !!paymentStatusFilterText,
            paymentStatusFilterOptions: !!paymentStatusFilterOptions,
            userStatusFilterBtn: !!userStatusFilterBtn,
            userStatusFilterText: !!userStatusFilterText,
            userStatusFilterOptions: !!userStatusFilterOptions
        });
        
        // Inicializar dropdowns com valores padrão
        const updatePaymentStatusFilter = (value, text) => {
            paymentStatusFilter = value;
            paymentStatusFilterText.textContent = text;
            
            // Atualiza os ícones de seleção
            const options = paymentStatusFilterOptions?.querySelectorAll('a') || [];
            options.forEach(option => {
                const icon = option?.querySelector('i');
                if (icon) {
                    icon.style.display = option.dataset.filter === value ? 'block' : 'none';
                }
            });
            
            renderStudentList();
        };

        const updateUserStatusFilter = (value, text) => {
            userStatusFilter = value;
            userStatusFilterText.textContent = text;
            
            // Atualiza os ícones de seleção
            const options = userStatusFilterOptions?.querySelectorAll('a') || [];
            options.forEach(option => {
                const icon = option?.querySelector('i');
                if (icon) {
                    icon.style.display = option.dataset.filter === value ? 'block' : 'none';
                }
            });
            
            renderStudentList();
        };

        // Configurar dropdowns apenas se os elementos existirem
        if (paymentStatusFilterBtn && paymentStatusFilterOptions) {
            setupDropdown(paymentStatusFilterBtn, paymentStatusFilterOptions, updatePaymentStatusFilter);
        }
        if (userStatusFilterBtn && userStatusFilterOptions) {
            setupDropdown(userStatusFilterBtn, userStatusFilterOptions, updateUserStatusFilter);
        }

        // Inicializar ícones Lucide primeiro
        lucide.createIcons();
        
        // Definir valores iniciais
        updatePaymentStatusFilter('all', 'Todos os Status');
        updateUserStatusFilter('all', 'Todos');
        
        // Garantir que os ícones de check estejam ocultos inicialmente
        document.querySelectorAll('#payment-status-filter-options i, #user-status-filter-options i').forEach(icon => {
            icon.style.display = 'none';
        });

        // --- FUNÇÕES HELPER ---
        const calculateAge = (dob) => {
            if (!dob) return '';
            const birthDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
            return age;
        };

        const getPaymentStatus = (dueDate) => {
            if (!dueDate) return { key: 'na', text: 'N/A', color: 'gray-500', variant: 'bg-gray-100 text-gray-800' };
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const vencimento = new Date(dueDate);
            vencimento.setHours(23, 59, 59, 999);
            const diffTime = vencimento - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays < 0) return { key: 'overdue', text: 'Atrasado', color: 'red-500', variant: 'bg-red-100 text-red-800' };
            if (diffDays <= 7) return { key: 'due', text: 'Perto do Vencimento', color: 'yellow-500', variant: 'bg-yellow-100 text-yellow-800' };
            return { key: 'paid', text: 'Em dia', color: 'green-500', variant: 'bg-green-100 text-green-800' };
        };

        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('pt-BR');
        };

        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        function renderStudentList() {
            console.log('Renderizando lista de alunos...');
            console.log('isFetching:', isFetching);
            console.log('Total de alunos:', students.length);
            
            if (isFetching) {
                studentListEl.innerHTML = `
                    <li class="flex items-center justify-center p-4 text-gray-400">
                        <i data-lucide="loader-2" class="w-5 h-5 mr-2 animate-spin"></i>
                        Buscando alunos...
                    </li>`;
                lucide.createIcons();
                return;
            }
            
            // Verifica se existem alunos para processar
            if (!Array.isArray(students) || students.length === 0) {
                console.log('Nenhum aluno encontrado para renderizar');
                studentListEl.innerHTML = `
                    <li class="text-center text-gray-400 p-4">
                        <i data-lucide="users" class="w-5 h-5 inline-block mr-1"></i>
                        Nenhum aluno encontrado.
                    </li>`;
                lucide.createIcons();
                return;
            }
            
            console.log('Processando alunos:', students);
            
            const filteredStudents = students
                .map(student => {
                    try {
                        // Garante que o aluno tenha as propriedades necessárias
                        if (!student) return null;
                        
                        // Encontra o pagamento mais recente
                        const latestPayment = student.pagamentos && student.pagamentos.length > 0
                            ? [...student.pagamentos].sort((a, b) => 
                                new Date(b.vencimento) - new Date(a.vencimento)
                              )[0]
                            : null;
                        
                        // Adiciona o status ao objeto do aluno
                        return { 
                            ...student, 
                            status: getPaymentStatus(latestPayment ? latestPayment.vencimento : null),
                            latestPaymentDate: latestPayment ? latestPayment.vencimento : null,
                            foto: student.foto || `https://ui-avatars.com/api/?name=${encodeURIComponent(student.nome || '')}&background=262D68&color=fff`
                        };
                    } catch (error) {
                        console.error('Erro ao processar aluno:', error, student);
                        return null;
                    }
                })
                .filter(Boolean) // Remove alunos nulos
                .filter(student => {
                    try {
                        // Filtra por termo de busca
                        const searchMatch = searchTerm === '' || 
                            (student.nome && student.nome.toLowerCase().includes(searchTerm.toLowerCase()));
                        
                        // Filtra por status de pagamento
                        let paymentStatusMatch = true;
                        if (paymentStatusFilter !== 'all') {
                            paymentStatusMatch = student.status && student.status.key === paymentStatusFilter;
                        }
                        
                        // Filtra por status do usuário
                        let userStatusMatch = true;
                        if (userStatusFilter === 'active') {
                            userStatusMatch = student.ativo === true;
                        } else if (userStatusFilter === 'inactive') {
                            userStatusMatch = student.ativo === false;
                        } // 'all' não filtra nada
                        
                        return searchMatch && paymentStatusMatch && userStatusMatch;
                    } catch (error) {
                        console.error('Erro ao filtrar aluno:', error, student);
                        return false;
                    }
                });
                
            console.log('Alunos filtrados:', filteredStudents);

            // Limpa a lista
            studentListEl.innerHTML = ''; 
            
            if (filteredStudents.length === 0) {
                studentListEl.innerHTML = `
                    <li class="text-center text-gray-400 p-4">
                        <i data-lucide="search" class="w-5 h-5 inline-block mr-1"></i>
                        Nenhum aluno encontrado com os filtros atuais.
                    </li>`;
                lucide.createIcons();
                return;
            }
            
            // Adiciona cada aluno à lista
            filteredStudents.forEach(student => {
                try {
                    if (!student || !student.id) return;
                    
                    const li = document.createElement('li');
                    li.className = `flex items-center p-3 rounded-lg cursor-pointer transition-all mb-2 ${selectedStudentId === student.id ? 'bg-indigo-500 bg-opacity-30' : 'hover:bg-gray-700'}`;
                    li.dataset.id = student.id;
                    
                    // Garante que a foto do aluno existe
                    const fotoUrl = student.foto || `https://ui-avatars.com/api/?name=${encodeURIComponent(student.nome || '')}&background=262D68&color=fff`;
                    
                    // Garante que o status existe
                    const status = student.status || { color: 'gray-500' };
                    
                    li.innerHTML = `
                        <div class="relative">
                            <img src="${fotoUrl}" alt="${student.nome || 'Aluno'}" 
                                 class="w-12 h-12 rounded-full object-cover border-2 border-${status.color}" 
                                 onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(student.nome || '')}&background=262D68&color=fff'" />
                        </div>
                        <div class="flex-grow ml-3 truncate">
                            <div class="font-medium text-gray-100 truncate">${student.nome || 'Nome não disponível'}</div>
                            <span class="text-xs px-2 py-0.5 rounded-full ${student.ativo ? 'bg-green-200 text-green-800' : 'bg-gray-500 text-white'}">
                                ${student.ativo ? 'Ativo' : 'Inativo'}
                            </span>
                        </div>
                    `;
                    
                    li.addEventListener('click', () => {
                        console.log('Aluno selecionado:', student.id);
                        selectedStudentId = student.id;
                        renderStudentList(); // Re-render a lista para destacar a seleção
                        renderStudentDetails();
                    });
                    
                    studentListEl.appendChild(li);
                } catch (error) {
                    console.error('Erro ao renderizar aluno:', error, student);
                }
            });
        }

        function renderStudentDetails() {
            if (selectedStudentId === null) {
                initialViewEl.classList.remove('hidden');
                studentDetailsContainerEl.classList.add('hidden');
                return;
            }

            const student = students.find(s => s.id === selectedStudentId);
            if (!student) return;

            const latestPayment = [...student.pagamentos].sort((a, b) => new Date(b.vencimento) - new Date(a.vencimento))[0];
            const status = getPaymentStatus(latestPayment ? latestPayment.vencimento : null);

            const getEditableFieldHTML = (id, label, value) => `
                    <div class="flex flex-col">
                        <label class="text-sm font-medium text-gray-500">${label}</label>
                        <div class="flex items-center gap-2 mt-1">
                            <p class="w-full px-3 py-2 text-gray-800 bg-gray-50 rounded-md min-h-[42px] flex items-center">${value}</p>
                            <button data-edit-id="${id}" class="p-2 text-indigo-600 bg-indigo-100 rounded-md hover:bg-indigo-200">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `;

            const paymentsHTML = student.pagamentos
                .sort((a, b) => new Date(b.dataPagamento) - new Date(a.dataPagamento))
                .map(p => {
                    const pStatus = getPaymentStatus(p.vencimento);
                    return `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${formatDate(p.dataPagamento)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${formatDate(p.vencimento)}</td>
                                <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${pStatus.variant}">${pStatus.text}</span></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">R$ ${p.valor.toFixed(2)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${p.formaPagamento}</td>
                            </tr>
                        `;
                }).join('');

            studentDetailsContainerEl.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex items-start justify-between mb-6">
                        <div>
                            <div class="flex items-center gap-3">
                               <h2 class="text-3xl font-bold text-gray-900">${student.nome}</h2>
                               <span class="text-sm mt-1 px-2.5 py-1 rounded-full font-medium ${student.ativo ? 'bg-green-100 text-green-800' : 'bg-gray-200 text-gray-800'}">${student.ativo ? 'Ativo' : 'Inativo'}</span>
                            </div>
                            <div class="mt-2 inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${status.variant}">
                                <i data-lucide="${status.key === 'paid' ? 'check-circle' : (status.key === 'due' ? 'alert-triangle' : 'x-circle')}" class="w-4 h-4 mr-2"></i>
                                Mensalidade ${status.text}
                            </div>
                        </div>
                        <img src="${student.foto}" alt="${student.nome}" class="w-20 h-20 rounded-full object-cover border-4 border-white shadow-md -mt-2"/>
                    </div>

                    <div class="border-b border-gray-200">
                         <nav id="tabs" class="-mb-px flex space-x-6">
                            <button data-tab="personal" class="py-3 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">Dados Pessoais</button>
                            <button data-tab="address" class="py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Endereço</button>
                            <button data-tab="payments" class="py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Pagamentos</button>
                         </nav>
                    </div>

                    <div class="mt-6">
                        <div id="tab-personal" class="">
                             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="bg-gray-50 p-4 rounded-lg"><label class="text-sm font-medium text-gray-500">CPF</label><p class="text-gray-800 font-semibold">${student.cpf}</p></div>
                                <div class="bg-gray-50 p-4 rounded-lg"><label class="text-sm font-medium text-gray-500">Gênero</label><p class="text-gray-800 font-semibold">${student.genero}</p></div>
                                <div class="bg-gray-50 p-4 rounded-lg"><label class="text-sm font-medium text-gray-500">Data de Nascimento</label><p class="text-gray-800 font-semibold">${formatDate(student.nascimento)}</p></div>
                                <div class="bg-gray-50 p-4 rounded-lg"><label class="text-sm font-medium text-gray-500">Idade</label><p class="text-gray-800 font-semibold">${calculateAge(student.nascimento)} anos</p></div>
                                ${getEditableFieldHTML('email', 'E-mail', student.email)}
                                ${getEditableFieldHTML('telefone', 'Telefone', student.telefone)}
                                ${getEditableFieldHTML('telefoneEmergencia', 'Telefone de Emergência', student.telefoneEmergencia)}
                                <div class="md:col-span-2 lg:col-span-3 p-4 rounded-lg border border-gray-200">
                                     <h4 class="font-bold text-gray-700 mb-3">Informações de Saúde</h4>
                                     <div class="flex items-center mb-3">
                                        <input type="checkbox" id="has-condition" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${student.possuiCondicaoMedica ? 'checked' : ''} />
                                        <label for="has-condition" class="ml-2 block text-sm text-gray-900">Possui alguma condição médica?</label>
                                     </div>
                                     <div id="condition-description-container" class="${student.possuiCondicaoMedica ? '' : 'hidden'}">
                                        <label for="condition-desc" class="block text-sm font-medium text-gray-700">Descrição da Condição</label>
                                        <textarea id="condition-desc" rows="3" class="mt-1 shadow-sm block w-full sm:text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">${student.descricaoCondicaoMedica || ''}</textarea>
                                     </div>
                                     <button id="save-medical-btn" class="mt-4 flex items-center gap-2 px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors text-sm font-medium">
                                         <i data-lucide="heart-pulse" class="w-4 h-4"></i> Salvar Informações de Saúde
                                     </button>
                                     <p id="medical-save-message" class="mt-2 text-sm text-green-600 hidden"></p>
                                </div>
                            </div>
                        </div>
                        <div id="tab-address" class="hidden">
                           <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${getEditableFieldHTML('cep', 'CEP', student.endereco.cep)}
                                ${getEditableFieldHTML('logradouro', 'Logradouro', student.endereco.logradouro)}
                                ${getEditableFieldHTML('numero', 'Número', student.endereco.numero)}
                                ${getEditableFieldHTML('complemento', 'Complemento', student.endereco.complemento)}
                                ${getEditableFieldHTML('bairro', 'Bairro', student.endereco.bairro)}
                           </div>
                        </div>
                        <div id="tab-payments" class="hidden">
                            <div class="flex justify-between items-center mb-4">
                                 <h3 class="text-xl font-bold text-gray-800">Histórico de Pagamentos</h3>
                                 <button id="add-payment-btn" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                                    Registrar Pagamento
                                 </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Pag.</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vencimento</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor Pago</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Forma Pag.</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${paymentsHTML}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Ações do Aluno</h3>
                        <div class="flex items-center gap-4">
                             <button id="toggle-active-btn" class="px-4 py-2 rounded-md font-medium text-sm ${student.ativo ? 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}">${student.ativo ? 'Desativar Aluno' : 'Ativar Aluno'}</button>
                             <button id="reset-password-btn" class="px-4 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200 font-medium text-sm">Redefinir Senha</button>
                        </div>
                         <p id="action-message" class="hidden mt-4 p-3 bg-green-100 text-green-800 border border-green-200 rounded-md text-sm"></p>
                    </div>
                </div>
                `;

            initialViewEl.classList.add('hidden');
            studentDetailsContainerEl.classList.remove('hidden');
            addDetailsEventListeners();
            lucide.createIcons(); // Recria os ícones
        }

        // --- FUNÇÕES DE CONTROLE DOS MODAIS E AÇÕES ---
        function setupDropdown(buttonEl, optionsEl, onSelect) {
            if (!buttonEl || !optionsEl) return;
            
            // Função para fechar o dropdown
            const closeDropdown = () => {
                optionsEl.classList.add('hidden');
                const icon = buttonEl.querySelector('i[data-lucide="chevron-down"]');
                if (icon) {
                    icon.style.transform = 'rotate(0deg)';
                }
            };
            
            // Adiciona evento de clique no botão para abrir/fechar
            buttonEl.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // Esconde outros dropdowns abertos
                document.querySelectorAll('[id$="-filter-options"]').forEach(el => {
                    if (el !== optionsEl) {
                        el.classList.add('hidden');
                    }
                });
                
                // Alterna o dropdown atual
                const isOpening = optionsEl.classList.toggle('hidden');
                const icon = buttonEl.querySelector('i[data-lucide="chevron-down"]');
                if (icon) {
                    icon.style.transform = isOpening ? 'rotate(0deg)' : 'rotate(180deg)';
                }
            });
            
            // Adiciona evento de clique nas opções do dropdown
            const options = optionsEl.querySelectorAll('a');
            options.forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const filterValue = this.dataset.filter;
                    const span = this.querySelector('span');
                    const filterText = span ? span.textContent.trim() : this.textContent.trim();
                    
                    // Atualiza a seleção
                    onSelect(filterValue, filterText);
                    
                    // Fecha o dropdown
                    closeDropdown();
                    
                    // Força o fechamento imediato
                    return false;
                });
            });
            
            // Fecha o dropdown ao clicar fora
            document.addEventListener('click', function closeOnClickOutside(e) {
                if (!buttonEl.contains(e.target) && !optionsEl.contains(e.target)) {
                    closeDropdown();
                }
            });
            
            // Fecha ao pressionar ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !optionsEl.classList.contains('hidden')) {
                    closeDropdown();
                }
            });
        }

        // O fechamento dos dropdowns agora é gerenciado pela função setupDropdown


        // --- EVENT LISTENERS ---
        function addDetailsEventListeners() {
            // Abas
            const tabs = document.getElementById('tabs');
            tabs.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const tabName = e.target.dataset.tab;

                    // Botões
                    tabs.querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('border-indigo-500', 'text-indigo-600');
                        btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    });
                    e.target.classList.add('border-indigo-500', 'text-indigo-600');
                    e.target.classList.remove('border-transparent', 'text-gray-500');

                    // Conteúdo
                    ['personal', 'address', 'payments'].forEach(tabId => {
                        document.getElementById(`tab-${tabId}`).classList.add('hidden');
                    });
                    document.getElementById(`tab-${tabName}`).classList.remove('hidden');
                }
            });

            // Botão de adicionar pagamento
            document.getElementById('add-payment-btn').addEventListener('click', () => {
                paymentModalEl.classList.remove('hidden');
            });

            // Botão de Ativar/Desativar
            document.getElementById('toggle-active-btn').addEventListener('click', showToggleActiveConfirm);

            // Botão de redefinir senha
            document.getElementById('reset-password-btn').addEventListener('click', showResetPasswordConfirm);

            // Checkbox de condição médica
            const hasConditionCheck = document.getElementById('has-condition');
            const conditionDescContainer = document.getElementById('condition-description-container');
            hasConditionCheck.addEventListener('change', (e) => {
                conditionDescContainer.classList.toggle('hidden', !e.target.checked);
            });

            // Botão de salvar informações médicas
            document.getElementById('save-medical-btn').addEventListener('click', saveMedicalInfo);
        }

        function saveMedicalInfo() {
            const student = students.find(s => s.id === selectedStudentId);
            const hasCondition = document.getElementById('has-condition').checked;
            const description = document.getElementById('condition-desc').value;

            student.possuiCondicaoMedica = hasCondition;
            student.descricaoCondicaoMedica = hasCondition ? description : '';

            const msgEl = document.getElementById('medical-save-message');
            msgEl.textContent = 'Informações médicas salvas com sucesso!';
            msgEl.classList.remove('hidden');
            setTimeout(() => msgEl.classList.add('hidden'), 4000);
        }

        function showActionMessage(message) {
            const msgEl = document.getElementById('action-message');
            msgEl.textContent = message;
            msgEl.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'border-red-200');
            msgEl.classList.add('bg-green-100', 'text-green-800', 'border-green-200');
            setTimeout(() => msgEl.classList.add('hidden'), 4000);
        }

        function showConfirmationModal({ title, message, confirmText, onConfirm }) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-message').textContent = message;
            const confirmBtn = document.getElementById('confirm-action-btn');
            confirmBtn.textContent = confirmText;
            confirmModalEl.classList.remove('hidden');

            const cancelBtn = document.getElementById('cancel-confirm-btn');

            const confirmAction = () => {
                onConfirm();
                closeModal();
            };
            const closeModal = () => {
                confirmModalEl.classList.add('hidden');
                confirmBtn.removeEventListener('click', confirmAction);
                cancelBtn.removeEventListener('click', closeModal);
            };

            confirmBtn.addEventListener('click', confirmAction);
            cancelBtn.addEventListener('click', closeModal);
        }

        function showResetPasswordConfirm() {
            showConfirmationModal({
                title: 'Redefinir Senha',
                message: 'Essa ação irá redefinir a senha do usuário para o valor padrão. Deseja continuar?',
                confirmText: 'Sim, redefinir',
                onConfirm: () => {
                    console.log(`Senha do aluno ${students.find(s=>s.id === selectedStudentId).nome} redefinida.`);
                    showActionMessage('A senha do aluno foi redefinida com sucesso!');
                }
            });
        }

        function showToggleActiveConfirm() {
            const student = students.find(s => s.id === selectedStudentId);
            const isActivating = !student.ativo;
            showConfirmationModal({
                title: `${isActivating ? 'Ativar' : 'Desativar'} Aluno`,
                message: `Você tem certeza que deseja ${isActivating ? 'ativar' : 'desativar'} este aluno?`,
                confirmText: `Sim, ${isActivating ? 'Ativar' : 'Desativar'}`,
                onConfirm: () => {
                    student.ativo = isActivating;
                    showActionMessage(`Aluno ${isActivating ? 'ativado' : 'desativado'} com sucesso!`);
                    renderStudentDetails(); // Atualiza a visualização de detalhes
                    renderStudentList(); // Atualiza a lista da sidebar
                }
            });
        }


        // Função para buscar alunos na API
        async function fetchStudents(name = '') {
            isFetching = true;
            renderStudentList(); // Mostra estado de carregamento
            
            try {
                const url = name ? `/alunos/all?nome=${encodeURIComponent(name)}` : '/alunos/all';
                const response = await fetch(url);
                if (!response.ok) throw new Error('Erro ao buscar alunos');
                
                const data = await response.json();
                // A API retorna um objeto com propriedade 'content' que contém o array de alunos
                const alunosData = data.content || [];
                
                students = alunosData.map(aluno => ({
                    ...aluno,
                    // Garante que os arrays existam
                    pagamentos: aluno.pagamentos || [],
                    // Garante que o endereço exista
                    endereco: aluno.endereco || {
                        cep: '',
                        logradouro: '',
                        numero: '',
                        complemento: '',
                        bairro: ''
                    }
                }));
                
                // Se houver apenas um resultado, seleciona automaticamente
                if (students.length === 1) {
                    selectedStudentId = students[0].id;
                    renderStudentDetails();
                } else if (students.length === 0) {
                    selectedStudentId = null;
                    renderStudentDetails();
                }
                
                renderStudentList();
            } catch (error) {
                console.error('Erro ao buscar alunos:', error);
                studentListEl.innerHTML = `
                    <li class="text-center p-4 text-red-500">
                        <i data-lucide="alert-circle" class="w-5 h-5 inline-block mr-1"></i>
                        Erro ao carregar alunos. Tente novamente.
                    </li>`;
                lucide.createIcons();
            } finally {
                isFetching = false;
            }
        }

        // Função para buscar alunos da API
        async function buscarAlunos(nome = '') {
            isFetching = true;
            renderStudentList(); // Mostra estado de carregamento
            
            try {
                // Usa o endpoint /alunos/todos que retorna todos os alunos sem paginação
                const url = nome ? `/alunos/todos?nome=${encodeURIComponent(nome)}` : '/alunos/todos';
                console.log('Buscando alunos na URL:', url);
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Erro ao buscar alunos: ' + response.status);
                
                const alunosData = await response.json();
                console.log('Dados recebidos:', alunosData);
                
                // Mapeia os dados dos alunos para o formato esperado
                students = alunosData.map(aluno => ({
                    id: aluno.id,
                    nome: aluno.nome || 'Nome não informado',
                    cpf: aluno.cpf || '',
                    email: aluno.email || '',
                    telefone: aluno.telefone || '',
                    ativo: aluno.ativo !== false, // Padrão para true se não definido
                    foto: aluno.foto || `https://ui-avatars.com/api/?name=${encodeURIComponent(aluno.nome || '')}&background=262D68&color=fff`,
                    pagamentos: aluno.pagamentos || [],
                    endereco: aluno.endereco || {
                        cep: '',
                        logradouro: '',
                        numero: '',
                        complemento: '',
                        bairro: ''
                    },
                    dataNascimento: aluno.dataNascimento || null,
                    genero: aluno.genero || 'NAO_INFORMADO',
                    dataCadastro: aluno.dataCadastro || new Date().toISOString()
                }));
                
                console.log('Alunos processados:', students);
                renderStudentList();
            } catch (error) {
                console.error('Erro ao buscar alunos:', error);
                studentListEl.innerHTML = `
                    <li class="text-center p-4 text-red-500">
                        <i data-lucide="alert-circle" class="w-5 h-5 inline-block mr-1"></i>
                        Erro ao carregar alunos: ${error.message}
                    </li>`;
                lucide.createIcons();
            } finally {
                isFetching = false;
            }
        }

        // Debounce para a busca
        function debounceSearch(value) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                buscarAlunos(value);
            }, 300); // 300ms de atraso
        }

        // Event listener para o input de busca
        if (searchInputEl) {
            searchInputEl.addEventListener('input', (e) => {
                searchTerm = e.target.value.trim();
                debounceSearch(searchTerm);
            });
        }

        cancelPaymentBtn.addEventListener('click', () => {
            paymentModalEl.classList.add('hidden');
            paymentFormEl.reset();
        });

        paymentFormEl.addEventListener('submit', (e) => {
            e.preventDefault();
            const newPayment = {
                id: Date.now(),
                valor: parseFloat(e.target.valor.value),
                formaPagamento: e.target.formaPagamento.value,
                vencimento: e.target.vencimento.value,
                dataPagamento: new Date().toISOString().split('T')[0]
            };

            const student = students.find(s => s.id === selectedStudentId);
            student.pagamentos.push(newPayment);

            renderStudentDetails();
            renderStudentList();

            paymentModalEl.classList.add('hidden');
            paymentFormEl.reset();
        });

        if (backBtn) {
            backBtn.addEventListener('click', () => {
                window.history.back();
            });
        } else {
            console.warn('Botão de voltar não encontrado no DOM');
        }

        // --- INICIALIZAÇÃO ---
        // Inicializa os ícones do Lucide
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        } else {
            console.warn('Lucide não foi carregado corretamente');
        }
        
        // Mostra o estado de carregamento inicial
        renderStudentList();
        
        // Função para carregar os alunos iniciais
        async function carregarAlunosIniciais() {
            try {
                console.log('Carregando alunos iniciais...');
                await buscarAlunos('');
                console.log('Alunos carregados com sucesso!');
                
                // Se houver alunos, seleciona o primeiro da lista
                if (students.length > 0) {
                    selectedStudentId = students[0].id;
                    renderStudentList();
                    renderStudentDetails();
                }
            } catch (error) {
                console.error('Erro ao carregar alunos iniciais:', error);
                studentListEl.innerHTML = `
                    <li class="text-center p-4 text-red-500">
                        <i data-lucide="alert-circle" class="w-5 h-5 inline-block mr-1"></i>
                        Erro ao carregar a lista de alunos. Por favor, recarregue a página.
                    </li>`;
                lucide.createIcons();
            }
        }
        
        // Inicia o carregamento dos alunos
        carregarAlunosIniciais();
        
        // Adiciona evento de tecla Enter na busca
        if (searchInputEl) {
            searchInputEl.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    buscarAlunos(searchTerm);
                }
            });
        }
    });
</script>

</body>
</html>
